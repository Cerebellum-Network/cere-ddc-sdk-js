version: "3.4"

services:
  ddc-cdn-node-0:
    platform: linux/amd64
    container_name: ddc-cdn-node-1
    image: "625402836641.dkr.ecr.us-west-2.amazonaws.com/ddc-cdn-node:dev-latest"
    environment:
      - 'HTTP_PORT=8081'
      - 'HTTP_ADDRESS=http://${HOST_IP}:8081'
      - 'LOG_LEVEL=debug'
      - 'LOG_JSON_FORMAT=false'
      - 'NODE_SECRET_PHRASE=//Bob'
      - "BLOCKCHAIN_API_URL=${BLOCKCHAIN_API_URL}"
      - "BLOCKCHAIN_DDC_BUCKET_CONTRACT=${BLOCKCHAIN_DDC_BUCKET_CONTRACT}"
      - "CLUSTER_ID=${CLUSTER_ID}"
    ports:
      - '8081:8081'
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${HOST_IP}:8081/info || exit 1
      interval: 3s
      timeout: 1s
      retries: 5
    depends_on:
      redis:
        condition: service_healthy

  ddc-cdn-node-2:
    platform: linux/amd64
    container_name: ddc-cdn-node-2
    image: "625402836641.dkr.ecr.us-west-2.amazonaws.com/ddc-cdn-node:dev-latest"
    environment:
      - 'HTTP_PORT=8082'
      - 'HTTP_ADDRESS=http://${HOST_IP}:8082'
      - 'LOG_LEVEL=debug'
      - 'LOG_JSON_FORMAT=false'
      - 'NODE_SECRET_PHRASE=//Dave'
      - "BLOCKCHAIN_API_URL=${BLOCKCHAIN_API_URL}"
      - "BLOCKCHAIN_DDC_BUCKET_CONTRACT=${BLOCKCHAIN_DDC_BUCKET_CONTRACT}"
      - "CLUSTER_ID=${CLUSTER_ID}"
    ports:
      - '8082:8082'
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${HOST_IP}:8082/info || exit 1
      interval: 3s
      timeout: 1s
      retries: 5
    depends_on:
      redis:
        condition: service_healthy

  ddc-storage-node-1:
    platform: linux/amd64
    container_name: ddc-storage-node-1
    image: "625402836641.dkr.ecr.us-west-2.amazonaws.com/ddc-storage-node:dev-latest"
    environment:
      - 'HTTP_PORT=8091'
      - 'HTTP_ADDRESS=http://ddc-storage-node-1:8091'
      - 'LOG_LEVEL=debug'
      - 'LOG_JSON_FORMAT=false'
      - 'NODE_SECRET_PHRASE=//Eve'
      - "DDC_BUCKET_CONTRACT_API_URL=${BLOCKCHAIN_API_URL}"
      - "DDC_BUCKET_CONTRACT_ACCOUNT_ID=${BLOCKCHAIN_DDC_BUCKET_CONTRACT}"
      - "CLUSTER_ID=${CLUSTER_ID}"
      - "DHT_ENABLED=true"
      - "PEER_URL=libp2p://ddc-storage-node-1:9071"
      - "PEER_SECRET_PHRASE=whip clump surface eternal summer acoustic broom duty magic extend virtual fly"
      - "GRPC_PORT=9091"
    ports:
      - '8091:8091'
      - '9071:9071'
      - '9091:9091'
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${HOST_IP}:8091/info || exit 1
      interval: 3s
      timeout: 1s
      retries: 5
    depends_on:
      redis:
        condition: service_healthy

  ddc-storage-node-2:
    platform: linux/amd64
    container_name: ddc-storage-node-2
    image: "625402836641.dkr.ecr.us-west-2.amazonaws.com/ddc-storage-node:dev-latest"
    environment:
      - 'HTTP_PORT=8092'
      - 'HTTP_ADDRESS=http://ddc-storage-node-2:8092'
      - 'LOG_LEVEL=debug'
      - 'LOG_JSON_FORMAT=false'
      - 'NODE_SECRET_PHRASE=//Ferdie'
      - "DDC_BUCKET_CONTRACT_API_URL=${BLOCKCHAIN_API_URL}"
      - "DDC_BUCKET_CONTRACT_ACCOUNT_ID=${BLOCKCHAIN_DDC_BUCKET_CONTRACT}"
      - "CLUSTER_ID=${CLUSTER_ID}"
      - "DHT_ENABLED=true"
      - "PEER_URL=libp2p://ddc-storage-node-2:9072"
      - "PEER_SECRET_PHRASE=scorpion dish want gorilla novel tape world hip rescue tank oyster pipe"
      - "GRPC_PORT=9092"
    ports:
      - '8092:8092'
      - '9072:9072'
      - '9092:9092'
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${HOST_IP}:8092/info || exit 1
      interval: 3s
      timeout: 1s
      retries: 5
    depends_on:
      redis:
        condition: service_healthy

  ddc-storage-node-3:
    platform: linux/amd64
    container_name: ddc-storage-node-3
    image: "625402836641.dkr.ecr.us-west-2.amazonaws.com/ddc-storage-node:dev-latest"
    environment:
      - 'HTTP_PORT=8093'
      - 'HTTP_ADDRESS=http://ddc-storage-node-3:8093'
      - 'LOG_LEVEL=debug'
      - 'LOG_JSON_FORMAT=false'
      - 'NODE_SECRET_PHRASE=//Charlie'
      - "DDC_BUCKET_CONTRACT_API_URL=${BLOCKCHAIN_API_URL}"
      - "DDC_BUCKET_CONTRACT_ACCOUNT_ID=${BLOCKCHAIN_DDC_BUCKET_CONTRACT}"
      - "CLUSTER_ID=${CLUSTER_ID}"
      - "DHT_ENABLED=true"
      - "PEER_URL=libp2p://ddc-storage-node-3:9073"
      - "PEER_SECRET_PHRASE=rule output true detect matrix wife raven wreck primary mansion spike coral"
      - "GRPC_PORT=9093"
    ports:
      - '8093:8093'
      - '9073:9073'
      - '9093:9093'
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${HOST_IP}:8093/info || exit 1
      interval: 3s
      timeout: 1s
      retries: 5
    depends_on:
      redis:
        condition: service_healthy

  ddc-storage-node-4:
    platform: linux/amd64
    container_name: ddc-storage-node-4
    image: "625402836641.dkr.ecr.us-west-2.amazonaws.com/ddc-storage-node:dev-latest"
    environment:
      - 'HTTP_PORT=8094'
      - 'HTTP_ADDRESS=http://ddc-storage-node-4:8094'
      - 'LOG_LEVEL=debug'
      - 'LOG_JSON_FORMAT=false'
      - 'NODE_SECRET_PHRASE=//Alice'
      - "DDC_BUCKET_CONTRACT_API_URL=${BLOCKCHAIN_API_URL}"
      - "DDC_BUCKET_CONTRACT_ACCOUNT_ID=${BLOCKCHAIN_DDC_BUCKET_CONTRACT}"
      - "CLUSTER_ID=${CLUSTER_ID}"
      - "DHT_ENABLED=true"
      - "PEER_URL=libp2p://ddc-storage-node-4:9074"
      - "PEER_SECRET_PHRASE=paper salon seed crystal gun envelope wolf twice pistol episode guitar borrow"
      - "GRPC_PORT=9094"
    ports:
      - '8094:8094'
      - '9074:9074'
      - '9094:9094'
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${HOST_IP}:8094/info || exit 1
      interval: 3s
      timeout: 1s
      retries: 5
    depends_on:
      redis:
        condition: service_healthy

  redis:
    image: 625402836641.dkr.ecr.us-west-2.amazonaws.com/dac-redis:dev-latest
    container_name: redis
    healthcheck:
      test: ["CMD-SHELL", "/healthchecker-runner.sh || exit 1"]
      interval: 10s
      timeout: 10s
      start_period: 10s
      retries: 5
    ports:
      - "6379:6379"

  webdis:
    image: nicolas/webdis:0.1.21
    container_name: webdis
    environment:
      REDIS_HOST: redis
    ports:
      - "7379:7379"
